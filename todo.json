{
  "v": 1,
  "id": "020-fabrik-v0-2-0",
  "tdd": false,
  "dod": ["bun run build", "manual CLI smoke tests"],
  "tasks": [
    {
      "id": "ts-dispatch",
      "do": "Implement TypeScript equivalent of scripts/dispatch.sh and wire fabrik run to use TS path.",
      "verify": "fabrik run works end-to-end on macOS and Linux (or at least macOS) without calling bash dispatch."
    },
    {
      "id": "ts-fleet",
      "do": "Implement TypeScript equivalent of scripts/smithers-fleet.sh and wire fabrik fleet to use TS path.",
      "verify": "fabrik fleet dispatches multiple specs successfully."
    },
    {
      "id": "ts-cleanup",
      "do": "Implement TypeScript equivalent of scripts/cleanup-workdirs.sh and wire fabrik cleanup to use TS path.",
      "verify": "fabrik cleanup removes old workdirs and respects --keep/--dry-run."
    },
    {
      "id": "ts-feedback",
      "do": "Implement TypeScript equivalent of scripts/record-human-feedback.sh and wire fabrik feedback to use TS path.",
      "verify": "fabrik feedback writes to DB and emits human-feedback.json in VM."
    },
    {
      "id": "remove-bash-deps",
      "do": "Remove reliance on bash scripts from the CLI; keep scripts only if needed for compatibility, otherwise delete.",
      "verify": "All fabrik commands work without shell scripts present."
    },
    {
      "id": "embedded-assets",
      "do": "Ensure embedded assets cover all required templates/workflows/docs and regenerate embeddedAssets.ts.",
      "verify": "Standalone fabrik binary runs with LOCAL_RALPH_HOME missing and can print docs + run commands."
    },
    {
      "id": "laos-command",
      "do": "Verify fabrik laos up/status/logs/down works with jj and git fallback; document requirements.",
      "verify": "fabrik laos status shows docker compose state and handles missing jj with git fallback."
    },
    {
      "id": "credentials-sync",
      "do": "Verify fabrik credentials sync mirrors scripts behavior including .config ownership fix.",
      "verify": "ralph.env and gh config sync succeeds on VM with root-owned /home/ralph/.config."
    },
    {
      "id": "release-readiness",
      "do": "Run build + CLI smoke tests; update docs if needed; prepare for v0.2.0 tag.",
      "verify": "bun run build succeeds; key CLI commands run without errors."
    },
    {
      "id": "test-vm-scripts",
      "do": "Test VM scripts on real VMs (macOS Lima + Linux libvirt), including create, setup, fleet, and multi-Ralph flows.",
      "verify": "All VM scripts run successfully on both macOS and Linux."
    },
    {
      "id": "claude-auth-flow",
      "do": "Validate Claude auth persistence and verify ~/.claude copies correctly across VM snapshots.",
      "verify": "Claude CLI works inside VM after snapshot restore."
    },
    {
      "id": "git-credentials-vm",
      "do": "Test PR creation from inside VM with git + GH auth.",
      "verify": "PR can be created from VM with copied credentials."
    },
    {
      "id": "jj-shared-workflow",
      "do": "Test shared spec workflow with JJ in real VM.",
      "verify": "JJ workflow operates correctly in VM for spec/todo runs."
    },
    {
      "id": "orchestrator-script",
      "do": "Implement orchestration helpers: parse spec → create JJ changes → assign to Ralphs; watch for DONE; collect PR links.",
      "verify": "Automated orchestration works end-to-end on a small fleet."
    },
    {
      "id": "prompt-templates",
      "do": "Improve prompt templates with examples and variable substitution; verify JSON outputs are well-formed.",
      "verify": "Prompts produce expected structured outputs across sample runs."
    },
    {
      "id": "message-queue",
      "do": "Implement shared filesystem message passing and implementer↔reviewer flow; add watcher for human notifications.",
      "verify": "Agents coordinate and human notifications trigger correctly."
    },
    {
      "id": "telemetry-integration",
      "do": "Add log shipping from Smithers/agents to Loki, Grafana dashboard, iteration/status metrics.",
      "verify": "Logs and metrics appear in Grafana dashboards."
    },
    {
      "id": "vm-template-cloning",
      "do": "Document Lima snapshot cloning and libvirt virt-clone workflow; measure time savings.",
      "verify": "Cloning docs are accurate and time savings measured."
    },
    {
      "id": "resource-monitoring",
      "do": "Add host resource checks and VM sizing suggestions.",
      "verify": "Warnings show when host resources are insufficient."
    },
    {
      "id": "web-ui-status",
      "do": "Build a simple web UI for fleet status with tmux links and PR links.",
      "verify": "Status page shows VM/task state and links."
    },
    {
      "id": "ci-cd-integration",
      "do": "Document Ralphs in CI and add a GitHub Actions example.",
      "verify": "CI docs include working example with self-hosted runner."
    },
    {
      "id": "reproducible-standalone",
      "do": "Verify fabrik runs from embedded assets on a fresh machine with no repo checkout.",
      "verify": "Standalone binary runs with LOCAL_RALPH_HOME missing and completes a docs + spec command."
    },
    {
      "id": "explicit-prereqs",
      "do": "Add explicit prerequisite checks (jj/git, docker, limactl/virsh) with actionable errors.",
      "verify": "Missing tools yield clear error messages and non-zero exit."
    },
    {
      "id": "run-auditability",
      "do": "Record CLI version, git SHA (if available), OS, and fabrik binary hash into run DB records.",
      "verify": "New run records include audit fields."
    },
    {
      "id": "idempotency",
      "do": "Ensure fabrik run only writes to workdir + ~/.cache/fabrik and does not mutate unrelated host state.",
      "verify": "Repeated runs do not alter host files outside intended paths."
    },
    {
      "id": "error-hygiene",
      "do": "Normalize error handling so all command failures surface clear exit codes and hints.",
      "verify": "Failing external commands provide actionable errors in CLI output."
    },
    {
      "id": "smithers-version",
      "do": "Verify Smithers version inside VM and fail fast if missing; record version in reports.",
      "verify": "Run fails early if smithers is absent and logs version when present."
    },
    {
      "id": "push-safety",
      "do": "Warn explicitly when --include-git is not set (push disabled) and when repo is not writable.",
      "verify": "CLI warns about push limitations in these cases."
    },
    {
      "id": "cli-known-issues",
      "do": "Add fabrik known-issues command that prints a concise list of common problems and the exact command sequence to resolve each one. Include the bun untrusted scripts flow: run `bun pm untrusted`, review package + script, then `bun pm trust <pkg>` if acceptable; otherwise remove the dependency.",
      "verify": "fabrik known-issues prints a short list with actionable copy-paste steps for each workaround, including the explicit bun untrusted trust-or-remove guidance."
    }
  ]
}
